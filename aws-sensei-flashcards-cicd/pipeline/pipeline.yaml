AWSTemplateFormatVersion: '2010-09-09'
Description: AWS-Sensei Pipeline (Source → InfraDeploy → BuildDeployHugo)

Parameters:
  ArtifactBucketName:
    Type: String
    Description: S3 bucket used for CodePipeline artifacts

  CodePipelineRoleArn:
    Type: String
    Description: IAM role ARN for CodePipeline

  CloudFormationExecutionRoleArn:
    Type: String
    Description: IAM role ARN used by CloudFormation during SAM deploy

  GitHubOwner:
    Type: String
    Default: AWS-Sensei

  GitHubRepo:
    Type: String
    Default: Flashcard-App

  GitHubBranch:
    Type: String
    Default: main


Resources:
    
  AWSSenseiFlashcardAppPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !Ref CodePipelineRoleArn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucketName
        EncryptionKey:
          Type: KMS
          Id: alias/aws/s3
      Stages:
        # ----------------------------------------------------------
        # SOURCE STAGE
        # ----------------------------------------------------------
        - Name: Source
          Actions:
            - Name: GitHub_Source
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: "1"
              OutputArtifacts:
                - Name: SourceOutput
              Configuration:
                Owner: !Ref GitHubOwner
                Repo: !Ref GitHubRepo
                Branch: !Ref GitHubBranch
                OAuthToken: "{{resolve:secretsmanager:GitHub-Connection:SecretString:token}}"
        # ----------------------------------------------------------
        # INFRASTRUCTURE DEPLOY (SAM)
        # ----------------------------------------------------------
        - Name: InfraDeploy
          Actions:
            - Name: SAM_Deploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              InputArtifacts:
                - Name: SourceOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: AWS-Sensei-Flashcard-App
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                TemplatePath: SourceOutput::infrastructure.yaml
                RoleArn: !Ref CloudFormationExecutionRoleArn
              Namespace: AWSSenseiFlashcardAppVariables
