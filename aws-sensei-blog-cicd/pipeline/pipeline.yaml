AWSTemplateFormatVersion: '2010-09-09'
Description: AWS-Sensei Pipeline (Source → InfraDeploy → BuildDeployHugo)

Parameters:
  ArtifactBucket:
    Type: String
    Description: S3 bucket used for CodePipeline artifacts

  CodePipelineRoleArn:
    Type: String
    Description: IAM role ARN for CodePipeline

  CloudFormationExecutionRoleArn:
    Type: String
    Description: IAM role ARN used by CloudFormation during SAM deploy

  HugoBuildProjectName:
    Type: String
    Description: CodeBuild project name for Hugo build

  GitHubOwner:
    Type: String
    Default: AWS-Sensei

  GitHubRepo:
    Type: String
    Default: Blog

  GitHubBranch:
    Type: String
    Default: main


Resources:
    
  AWSSenseiBlogPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !Ref CodePipelineRoleArn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
      Stages:
        # ----------------------------------------------------------
        # SOURCE STAGE
        # ----------------------------------------------------------
        - Name: Source
          Actions:
            - Name: GitHub_Source
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: "1"
              OutputArtifacts:
                - Name: SourceOutput
              Configuration:
                Owner: !Ref GitHubOwner
                Repo: !Ref GitHubRepo
                Branch: !Ref GitHubBranch
                OAuthToken: "{{resolve:secretsmanager:GitHub-Connection:SecretString:token}}"
        # ----------------------------------------------------------
        # INFRASTRUCTURE DEPLOY (SAM)
        # ----------------------------------------------------------
        - Name: InfraDeploy
          Actions:
            - Name: SAM_Deploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              InputArtifacts:
                - Name: SourceOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: AWS-Sensei-Blog
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                TemplatePath: SourceOutput::infrastructure.yaml
                RoleArn: !Ref CloudFormationExecutionRoleArn
              Namespace: AWSSenseiBlogVariables
        # ----------------------------------------------------------
        # HUGO BUILD & DEPLOY
        # ----------------------------------------------------------
        - Name: BuildDeployHugo
          Actions:
            - Name: Hugo_Build
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              InputArtifacts:
                - Name: SourceOutput
              Configuration:
                ProjectName: !Ref HugoBuildProjectName
                EnvironmentVariables: |
                  [
                    {
                      "name": "WEBSITE_BUCKET",
                      "value": "#{AWSSenseiBlogVariables.WebsiteBucketName}",
                      "type": "PLAINTEXT"
                    },
                    {
                      "name": "CLOUDFRONT_DISTRIBUTION_ID",
                      "value": "#{AWSSenseiBlogVariables.CloudFrontDistribution}",
                      "type": "PLAINTEXT"
                    }
                  ]
                  
Outputs:
  PipelineName:
    Value: !Ref AWSSenseiBlogPipeline
  PipelineArn:
    Value: !GetAtt AWSSenseiBlogPipeline.Arn
